<!-- 
  FILENAME: admin.html
  APP: Govinda HQ (Admin Panel) - UPDATED 15.0 (Ultimate WhatsApp Billing & 200k Scale)
  DEV: Fixed WhatsApp Message Cutting, Added Server-Side Limits, Full Control
-->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Govinda HQ | Enterprise Admin</title>

    <!-- ICONS & FONTS -->
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@300;400;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        :root {
            --brand: #FF6D00;
            --dark: #1A1D1F;
            --light: #F4F4F4;
            --white: #ffffff;
            --text: #111;
            --sidebar: 260px;
            --success: #27AE60;
            --danger: #EB5757;
            --warn: #F2C94C;
            --whatsapp: #25D366;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Manrope', sans-serif; outline: none; -webkit-tap-highlight-color: transparent; }
        body { background: var(--light); color: var(--text); display: flex; height: 100vh; overflow: hidden; }

        /* --- AUTH SCREEN --- */
        #view-auth { position: fixed; inset: 0; background: var(--dark); z-index: 9999; display: flex; align-items: center; justify-content: center; }
        .auth-box { background: white; padding: 40px; width: 380px; max-width: 90%; border-radius: 16px; text-align: center; box-shadow: 0 20px 50px rgba(0,0,0,0.3); }
        .auth-inp { width: 100%; padding: 14px; border: 1px solid #ddd; border-radius: 8px; margin-bottom: 15px; font-size: 1rem; }
        
        /* --- SIDEBAR --- */
        aside { width: var(--sidebar); background: var(--dark); color: #9A9FA5; display: flex; flex-direction: column; transition: 0.3s; position: relative; z-index: 100; }
        @media (max-width: 768px) { aside { position: fixed; left: -100%; top: 0; bottom: 0; width: 280px; box-shadow: 10px 0 30px rgba(0,0,0,0.2); } aside.open { left: 0; } }
        .logo { height: 80px; display: flex; align-items: center; padding: 0 25px; font-weight: 800; font-size: 1.4rem; color: white; border-bottom: 1px solid #2F3336; }
        .logo span { color: var(--brand); margin-right: 10px; }
        .nav-list { padding: 20px 15px; overflow-y: auto; flex: 1; }
        .nav-btn { padding: 14px 15px; margin-bottom: 5px; cursor: pointer; border-radius: 10px; font-weight: 600; display: flex; align-items: center; gap: 15px; transition: 0.2s; }
        .nav-btn:hover, .nav-btn.active { background: var(--brand); color: white; }
        .nav-btn i { width: 20px; text-align: center; font-size: 1.1rem; }

        /* --- MAIN --- */
        #overlay-sidebar { position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 90; display: none; backdrop-filter: blur(2px); }
        #overlay-sidebar.show { display: block; }
        main { flex: 1; display: flex; flex-direction: column; overflow: hidden; position: relative; }
        header { height: 70px; background: white; border-bottom: 1px solid #EFEFEF; display: flex; justify-content: space-between; align-items: center; padding: 0 20px; z-index: 80; }
        .h-left { display: flex; align-items: center; gap: 15px; }
        .menu-toggle { display: none; font-size: 1.4rem; cursor: pointer; color: var(--dark); }
        .h-title { font-weight: 800; font-size: 1.3rem; color: var(--dark); }
        @media (max-width: 768px) { .menu-toggle { display: block; } .h-title { font-size: 1.1rem; } }
        .store-switch { display: flex; align-items: center; gap: 10px; padding: 6px 12px; background: #f0f0f0; border-radius: 30px; border: 2px solid transparent; transition: 0.3s; font-size: 0.8rem; }
        .store-switch.online { background: #E8F5E9; border-color: var(--success); }
        .store-switch.offline { background: #FFEBEE; border-color: var(--danger); }
        .content { padding: 20px; overflow-y: auto; flex: 1; -webkit-overflow-scrolling: touch; }

        /* --- COMPONENTS --- */
        .grid-4 { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-bottom: 25px; }
        .grid-2 { display: grid; grid-template-columns: 1fr 1.5fr; gap: 20px; }
        @media (max-width: 1024px) { .grid-4 { grid-template-columns: repeat(2, 1fr); } .grid-2 { grid-template-columns: 1fr; } }
        @media (max-width: 600px) { .grid-4 { grid-template-columns: 1fr; } }
        .card { background: white; padding: 20px; border-radius: 16px; box-shadow: 0 4px 10px rgba(0,0,0,0.02); border: 1px solid #EFEFEF; }
        .kpi-val { font-size: 1.8rem; font-weight: 800; margin-top: 5px; color: var(--dark); }
        .kpi-lbl { font-size: 0.75rem; text-transform: uppercase; color: #888; font-weight: 700; }
        .tbl-box { overflow-x: auto; border-radius: 10px; border: 1px solid #eee; margin-top: 10px; }
        table { width: 100%; border-collapse: collapse; min-width: 600px; background: white; }
        th { text-align: left; padding: 12px; background: #FAFAFA; font-size: 0.7rem; text-transform: uppercase; color: #555; font-weight: 800; }
        td { padding: 12px; border-bottom: 1px solid #f9f9f9; font-size: 0.85rem; font-weight: 600; color: #333; vertical-align: middle; }
        .badge { padding: 4px 8px; border-radius: 6px; font-size: 0.7rem; font-weight: 700; text-transform: uppercase; display: inline-block; white-space: nowrap; }
        .bg-new { background: #FFF3E0; color: #F57C00; } .bg-cook { background: #E3F2FD; color: #1976D2; } .bg-out { background: #F3E5F5; color: #7B1FA2; } .bg-done { background: #E8F5E9; color: #2E7D32; } .bg-can { background: #FFEBEE; color: #C62828; }
        .btn { padding: 12px 20px; border: none; border-radius: 10px; font-weight: 700; cursor: pointer; transition: 0.2s; display: inline-flex; align-items: center; justify-content: center; gap: 8px; font-size: 0.9rem; }
        .btn:active { transform: scale(0.96); }
        .b-prim { background: var(--brand); color: white; } .b-dark { background: var(--dark); color: white; } .b-succ { background: var(--success); color: white; } .b-dang { background: var(--danger); color: white; } .b-info { background: #2D9CDB; color: white; }
        .b-wa { background: var(--whatsapp); color: white; }
        .b-sm { padding: 6px 12px; font-size: 0.8rem; border-radius: 6px; }
        .inp { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 10px; margin-bottom: 15px; outline: none; background: #f9f9f9; }
        .inp-grp { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 2000; display: none; align-items: flex-end; justify-content: center; backdrop-filter: blur(4px); }
        @media (min-width: 600px) { .modal { align-items: center; } }
        .modal-box { background: white; width: 550px; max-width: 100%; max-height: 90vh; padding: 25px; border-radius: 20px 20px 0 0; overflow-y: auto; animation: slideUp 0.3s; box-shadow: 0 -10px 40px rgba(0,0,0,0.2); }
        @media (min-width: 600px) { .modal-box { border-radius: 20px; animation: popIn 0.3s; } }
        @keyframes slideUp { from{transform:translateY(100%);} to{transform:translateY(0);} }
        @keyframes popIn { from{transform:scale(0.95); opacity:0;} to{transform:scale(1); opacity:1;} }
        .close-x { float: right; font-size: 1.5rem; cursor: pointer; color: #aaa; width: 40px; height: 40px; display: grid; place-items: center; background: #f5f5f5; border-radius: 50%; }
        .prev-main-img { width: 100%; height: 200px; object-fit: contain; border-radius: 12px; border: 1px solid #eee; margin-bottom: 10px; background: #fafafa; }
        .thumb-row { display: flex; gap: 10px; overflow-x: auto; padding-bottom: 5px; }
        .thumb-img { width: 50px; height: 50px; object-fit: cover; border-radius: 8px; cursor: pointer; border: 2px solid transparent; opacity: 0.7; }
        .thumb-img.active-thumb { border-color: var(--brand); opacity: 1; }
        .unit-tag { display: inline-block; background: #FFF3E0; color: #E65100; font-size: 0.75rem; padding: 2px 8px; border-radius: 4px; font-weight: 700; margin-bottom: 5px; }
        #invoice-layout { display: none; width: 80mm; padding: 2mm; background: white; color: black; font-family: 'Courier New', monospace; line-height: 1.2; }
        @media print { body * { visibility: hidden; } #invoice-layout, #invoice-layout * { visibility: visible; } #invoice-layout { position: absolute; left: 0; top: 0; width: 100%; display: block; } }
        .switch { position: relative; display: inline-block; width: 40px; height: 22px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 16px; width: 16px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--success); }
        input:checked + .slider:before { transform: translateX(18px); }
        .hide { display: none !important; }
        .flex-between { display: flex; justify-content: space-between; align-items: center; }
        .text-sm { font-size: 0.85rem; color: #666; }
        
        /* AUDIO CONTROLS (Hidden) */
        #order-sound { display: none; }

        /* TABS FOR DRIVER ASSIGN */
        .driver-tabs { display: flex; margin-bottom: 15px; border-bottom: 1px solid #eee; gap:10px; }
        .d-tab { padding: 10px 15px; font-size: 0.9rem; font-weight: bold; cursor: pointer; color: #888; border-bottom: 3px solid transparent; }
        .d-tab.active { color: var(--brand); border-color: var(--brand); }

        /* REVIEW STARS */
        .star-gold { color: #F59E0B; }
        .star-gray { color: #E0E0E0; }
        .device-badge { font-size: 0.7rem; background: #F3E5F5; color: #7B1FA2; padding: 2px 6px; border-radius: 4px; margin-left: 5px; }
        
        /* SETTINGS TOGGLE ROW */
        .setting-row { display: flex; justify-content: space-between; align-items: center; padding: 15px 0; border-bottom: 1px solid #eee; }
    </style>
</head>
<body>

    <!-- AUDIO FOR ORDER ALERT -->
    <audio id="order-sound" src="https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3" preload="auto"></audio>

    <!-- PRINT TEMPLATE -->
    <div id="invoice-layout">
        <center>
            <h2 style="margin:0; font-weight:800; font-size:16px;">GOVINDA'S</h2>
            <p style="font-size:10px; margin:2px;">ISKCON Hadapsar, Pune</p>
            <p style="font-size:10px; border-bottom:1px dashed #000; padding-bottom:5px;">Pure Veg â€¢ Satvik â€¢ Divine</p>
        </center>
        <div style="font-size:11px; margin-top:10px;">Order: <b id="inv-id">#0000</b><br>Name: <span id="inv-name">--</span><br>Time: <span id="inv-date">--</span></div>
        <table style="width:100%; font-size:11px; margin-top:10px; border-top:1px dashed #000; border-bottom:1px dashed #000;">
            <thead><tr style="text-align:left;"><th>Item</th><th style="text-align:right;">Price</th></tr></thead>
            <tbody id="inv-items"></tbody>
        </table>
        <div style="text-align:right; font-size:11px; margin-top:5px;"><div id="inv-sub">Sub: 0</div><div id="inv-del">Del: 0</div><div id="inv-disc">Disc: 0</div><b style="font-size:14px; margin-top:5px; display:block;">TOTAL: <span id="inv-total">0</span></b></div>
        <center style="font-size:10px; margin-top:15px; font-weight:bold;">** THANK YOU **<br> Hare Krishna!</center>
    </div>

    <div id="view-auth">
        <div class="auth-box">
            <h1 style="color:var(--brand); font-weight:900;"><i class="fa-solid fa-om"></i> GOVINDA</h1>
            <p style="color:#888; margin-bottom:25px;">Admin Control Center</p>
            <input type="email" id="login-email" class="auth-inp" placeholder="Admin Email">
            <input type="password" id="login-pass" class="auth-inp" placeholder="Password">
            <button class="btn b-prim" style="width:100%; padding:15px;" onclick="handleLogin()">SECURE LOGIN</button>
            <p id="auth-err" style="color:red; font-size:0.8rem; margin-top:15px;"></p>
        </div>
    </div>

    <div id="overlay-sidebar" onclick="toggleSidebar()"></div>

    <aside id="sidebar">
        <div class="logo"><span><i class="fa-solid fa-om"></i></span> HQ</div>
        <div class="nav-list">
            <div class="nav-btn active" onclick="nav('dashboard', this)"><i class="fa-solid fa-chart-pie"></i> Dashboard</div>
            <div class="nav-btn" onclick="nav('menu', this)"><i class="fa-solid fa-utensils"></i> Menu & Dishes</div>
            <div class="nav-btn" onclick="nav('orders', this)">
                <i class="fa-solid fa-bell"></i> Orders 
                <span id="nav-badge" style="margin-left:auto; background:var(--danger); color:white; padding:2px 6px; border-radius:6px; font-size:0.7rem; display:none;">0</span>
            </div>
            <div class="nav-btn" onclick="nav('reviews', this)"><i class="fa-solid fa-star"></i> Reviews</div>
            <div class="nav-btn" onclick="nav('customers', this)"><i class="fa-solid fa-users"></i> Customers</div>
            <div class="nav-btn" onclick="nav('marketing', this)"><i class="fa-solid fa-ticket"></i> Coupons/Banners</div>
            <div class="nav-btn" onclick="nav('drivers', this)"><i class="fa-solid fa-user-group"></i> Drivers</div>
            <div class="nav-btn" onclick="nav('settings', this)"><i class="fa-solid fa-sliders"></i> Settings</div>
        </div>
        
        <!-- BROADCAST BUTTON -->
        <div style="padding:20px;">
            <button class="btn b-info" onclick="modal('m-broadcast')" style="width:100%; margin-bottom:10px; font-weight:800; background:#2196F3;">
                <i class="fa-solid fa-bullhorn"></i> Broadcast Offer
            </button>
            <div style="background:#2C3035; padding:15px; border-radius:12px; cursor:pointer; text-align:center; color:#FF5252; font-weight:bold;" onclick="logout()">
                <i class="fa-solid fa-power-off"></i> LOGOUT
            </div>
        </div>
    </aside>

    <main>
        <header>
            <div class="h-left"><div class="menu-toggle" onclick="toggleSidebar()"><i class="fa-solid fa-bars"></i></div><div class="h-title" id="page-title">DASHBOARD</div></div>
            <div id="store-toggle" class="store-switch online"><div style="font-weight:700;" id="store-status-text">ONLINE</div><label class="switch"><input type="checkbox" id="master-switch" checked onchange="toggleStore(this.checked)"><span class="slider"></span></label></div>
        </header>

        <div class="content">
            <div id="view-dashboard">
                <div class="grid-4">
                    <div class="card" style="border-left:5px solid var(--brand)"><div class="kpi-lbl">Revenue</div><div class="kpi-val" id="d-sales">â‚¹0</div></div>
                    <div class="card" style="border-left:5px solid var(--success)"><div class="kpi-lbl">Total Orders</div><div class="kpi-val" id="d-orders">0</div></div>
                    <div class="card" style="border-left:5px solid var(--warn)"><div class="kpi-lbl">Kitchen Queue</div><div class="kpi-val" id="d-pending">0</div></div>
                    <div class="card" style="border-left:5px solid var(--dark)"><div class="kpi-lbl">Dishes</div><div class="kpi-val" id="d-items">0</div></div>
                </div>
                <div class="card"><h3>Analytics</h3><div style="height:300px; width:100%;"><canvas id="sales-chart"></canvas></div></div>
            </div>

            <div id="view-menu" class="hide">
                <div class="grid-2">
                    <div class="card" style="height:fit-content;">
                        <div class="flex-between" style="margin-bottom:15px;"><h3>Categories</h3><button class="btn b-dark b-sm" onclick="openCatModal()">+ Add</button></div>
                        <div id="cat-list" style="display:flex; flex-direction:column; gap:10px;"></div>
                    </div>
                    <div class="card">
                        <div class="flex-between" style="margin-bottom:15px;"><h3>Menu Items</h3><button class="btn b-prim b-sm" onclick="openAddItemModal()">+ Add New Dish</button></div>
                        <div class="tbl-box"><table id="item-list"><thead><tr><th>Dish</th><th>Price</th><th>Act</th></tr></thead><tbody></tbody></table></div>
                    </div>
                </div>
            </div>

            <div id="view-orders" class="hide">
                <div class="card">
                    <div class="flex-between" style="margin-bottom:15px;"><h3>Orders Stream</h3><div style="font-size:0.75rem; color:var(--success); font-weight:700;"><i class="fa-solid fa-wifi"></i> LIVE</div></div>
                    <div class="tbl-box"><table id="order-list"><thead><tr><th>Order</th><th>Info</th><th>Total</th><th>Status</th><th>Act</th></tr></thead><tbody></tbody></table></div>
                </div>
            </div>

            <div id="view-reviews" class="hide">
                <div class="card">
                    <div class="flex-between" style="margin-bottom:15px;">
                        <h3>User Reviews</h3>
                        <button class="btn b-succ b-sm" onclick="openReviewModal()">+ Add Review</button>
                    </div>
                    <div class="tbl-box">
                        <table id="review-list-table">
                            <thead><tr><th>Product</th><th>User</th><th>Rating</th><th>Comment</th><th>Date</th><th>Action</th></tr></thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="view-customers" class="hide">
                <div class="card">
                    <h3>Registered Customers</h3>
                    <div class="tbl-box" style="margin-top:15px;">
                        <table id="customer-list-table">
                            <thead><tr><th>Name</th><th>Phone</th><th>Email</th><th>Address</th><th>Stats</th></tr></thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="view-marketing" class="hide">
                <div class="grid-2">
                    <div class="card"><div class="flex-between"><h3>App Banners</h3> <button class="btn b-prim b-sm" onclick="modal('m-ban')">+ Add</button></div><div id="ban-list" style="margin-top:15px; display:grid; grid-template-columns:1fr 1fr; gap:10px;"></div></div>
                    <div class="card"><div class="flex-between"><h3>Coupons</h3> <button class="btn b-succ b-sm" onclick="openCoupModal()">+ New</button></div><div id="coup-list" style="margin-top:15px;"></div></div>
                </div>
            </div>

            <div id="view-drivers" class="hide">
                <div class="card"><h3>Drivers (Staff)</h3><div class="tbl-box" style="margin-top:15px;"><table id="driver-list"><thead><tr><th>Name</th><th>Phone</th><th>Status</th><th>Action</th></tr></thead><tbody></tbody></table></div></div>
            </div>

            <!-- ENHANCED SETTINGS: A-TO-Z CONTROL -->
            <div id="view-settings" class="hide">
                <div class="card" style="max-width: 600px; margin: 0 auto;">
                    <h3><i class="fa-solid fa-sliders"></i> Master Control (A-Z)</h3>
                    <div style="margin-top:20px; background:#fff; border:1px solid #eee; padding:20px; border-radius:12px;">
                        
                        <div class="setting-row">
                            <div><b>Cash on Delivery (COD)</b><div class="text-sm">Allow users to pay cash</div></div>
                            <label class="switch"><input type="checkbox" id="set-cod"><span class="slider"></span></label>
                        </div>

                        <div class="setting-row">
                            <div><b>Online Discount</b><div class="text-sm">Percentage OFF on Prepaid</div></div>
                            <input type="number" id="set-online-disc" class="inp" style="width:80px; margin:0;" placeholder="0">
                        </div>

                        <h4 style="margin:20px 0 10px; color:var(--brand);">Delivery Config</h4>
                        <div class="inp-grp">
                            <div><label class="text-sm">Delivery Fee (â‚¹)</label><input type="number" id="set-del-fee" class="inp" placeholder="20"></div>
                            <div><label class="text-sm">Free Delivery Above (â‚¹)</label><input type="number" id="set-free-min" class="inp" placeholder="500"></div>
                        </div>

                        <button class="btn b-prim" style="width:100%; margin-top:20px; padding:15px;" onclick="saveSettings()">UPDATE CONTROLS</button>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- MANUAL REVIEW MODAL (Add/Edit) -->
    <div id="m-add-review" class="modal">
        <div class="modal-box">
            <div class="flex-between"><h3 id="rev-modal-title">Add/Edit Review</h3><div class="close-x" onclick="shut('m-add-review')">&times;</div></div>
            <input type="hidden" id="ar-id"> <!-- To store Review ID if editing -->
            
            <label class="text-sm">Select Product</label>
            <select id="ar-product" class="inp"></select>
            
            <div class="inp-grp">
                <div><label class="text-sm">User Name</label><input type="text" id="ar-name" class="inp" placeholder="e.g. Amit K."></div>
                <div><label class="text-sm">Rating (1-5)</label><input type="number" id="ar-rating" class="inp" min="1" max="5" value="5"></div>
            </div>
            <label class="text-sm">Comment</label>
            <textarea id="ar-comment" class="inp" rows="3" placeholder="Food was divine..."></textarea>
            <button class="btn b-succ" style="width:100%" onclick="saveAdminReview()">SAVE REVIEW</button>
        </div>
    </div>

    <!-- BROADCAST MODAL -->
    <div id="m-broadcast" class="modal">
        <div class="modal-box">
            <div class="flex-between"><h3>ðŸ“¢ Broadcast Offer</h3><div class="close-x" onclick="shut('m-broadcast')">&times;</div></div>
            <p style="font-size:0.9rem; color:#666; margin-bottom:15px; background:#f0f9ff; padding:10px; border-radius:8px;">Send a notification to <b>ALL</b> customers.</p>
            <label class="text-sm">Notification Title</label><input type="text" id="br-title" class="inp" placeholder="e.g. MEGA 50% SALE!">
            <label class="text-sm">Message Body</label><textarea id="br-msg" class="inp" rows="3" placeholder="Describe the offer..."></textarea>
            <button class="btn b-info" style="width:100%" onclick="sendBroadcast()">SEND NOW ðŸš€</button>
        </div>
    </div>

    <!-- CATEGORY MODAL -->
    <div id="m-cat" class="modal">
        <div class="modal-box">
            <div class="flex-between"><h3 id="cat-modal-title">Manage Category</h3> <div class="close-x" onclick="shut('m-cat')">&times;</div></div>
            <input type="hidden" id="c-id">
            <label class="text-sm">Name</label> <input type="text" id="c-name" class="inp">
            <label class="text-sm">Image Link</label> <input type="text" id="c-img" class="inp">
            <button class="btn b-prim" style="width:100%" onclick="saveCat()">SAVE CATEGORY</button>
        </div>
    </div>
    
    <div id="m-item" class="modal">
        <div class="modal-box">
            <div class="flex-between"><h3 id="item-modal-title">Manage Dish</h3> <div class="close-x" onclick="shut('m-item')">&times;</div></div>
            <input type="hidden" id="i-id">
            <label class="text-sm">Dish Name</label><input type="text" id="i-name" class="inp">
            <div class="inp-grp"><div><label class="text-sm">Category</label><select id="i-cat" class="inp"></select></div><div><label class="text-sm">Price (â‚¹)</label><input type="number" id="i-price" class="inp"></div></div>
            <div class="inp-grp"><div><label class="text-sm">Unit (e.g kg/pc)</label><select id="i-unit-type" class="inp"><option value="">Plate</option><option value="kg">kg</option><option value="gm">gm</option><option value="pc">Pc</option><option value="ltr">Ltr</option></select></div><div><label class="text-sm">Val (e.g. 1 or 500)</label><input type="number" id="i-unit-val" class="inp"></div></div>
            <label class="text-sm">Description</label><input type="text" id="i-desc" class="inp">
            <label class="text-sm">Stock Qty</label><input type="number" id="i-stk" class="inp">
            <div style="background:#F4F4F4; padding:15px; border-radius:10px; margin-bottom:15px;">
                <label class="text-sm" style="color:var(--brand); font-weight:bold;">Primary Image</label><input type="text" id="i-img" class="inp" placeholder="https://...">
                <details><summary style="font-size:0.8rem; cursor:pointer; margin-bottom:10px;">+ Extra Gallery Images</summary><input type="text" id="i-img-1" class="inp" placeholder="Slider Img 1"><input type="text" id="i-img-2" class="inp" placeholder="Slider Img 2"><input type="text" id="i-img-3" class="inp" placeholder="Slider Img 3"></details>
            </div>
            <button class="btn b-prim" style="width:100%" onclick="saveItem()">SAVE PRODUCT</button>
        </div>
    </div>

    <div id="m-prod-view" class="modal"><div class="modal-box"><div class="close-x" style="position:absolute; top:20px; right:20px; z-index:10;" onclick="shut('m-prod-view')">&times;</div><div id="pv-content"></div></div></div>
    
    <div id="m-order" class="modal"><div class="modal-box"><div class="flex-between"><h3>Manage Order</h3> <div class="close-x" onclick="shut('m-order')">&times;</div></div><div id="k-order-body" style="margin-top:15px;"></div></div></div>
    
    <div id="m-ban" class="modal"><div class="modal-box"><div class="close-x" onclick="shut('m-ban')">&times;</div><h3>Add Banner</h3><label>Image URL</label><input type="text" id="b-img" class="inp"><button class="btn b-prim" onclick="saveBan()" style="width:100%">UPLOAD</button></div></div>
    
    <!-- COUPON MODAL -->
    <div id="m-coup" class="modal">
        <div class="modal-box">
            <div class="close-x" onclick="shut('m-coup')">&times;</div>
            <h3>Create Coupon</h3>
            <label>Code (Caps)</label><input type="text" id="cp-code" class="inp" style="text-transform:uppercase;">
            <div class="inp-grp">
                <div><label>Value</label><input type="number" id="cp-val" class="inp"></div>
                <div><label>Type</label><select id="cp-type" class="inp"><option value="flat">â‚¹ Flat</option><option value="percent">% Off</option></select></div>
            </div>
            <label>Valid For Category (Optional)</label>
            <select id="cp-cat" class="inp"><option value="">All Menu (Global)</option></select>
            <label>Min Order</label><input type="number" id="cp-min" class="inp">
            <button class="btn b-succ" onclick="saveCoup()" style="width:100%">LAUNCH</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";
        import { getDatabase, ref, update, onValue, set, push, remove, get, serverTimestamp, query, limitToLast } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js";

        // FIREBASE CONFIG
        const firebaseConfig = {
            apiKey: "AIzaSyAQLRmywrD0NSibvuwiVbiO_YzBRRq5k98",
            authDomain: "iskcon-food.firebaseapp.com",
            databaseURL: "https://iskcon-food-default-rtdb.firebaseio.com",
            projectId: "iskcon-food",
            storageBucket: "iskcon-food.firebasestorage.app",
            messagingSenderId: "987150159471",
            appId: "1:987150159471:web:c5f8506191ef06d147479a"
        };
        
        const FCM_SERVER_KEY = "AIzaSyAQLRmywrD0NSibvuwiVbiO_YzBRRq5k98"; 

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);

        let DB = { orders: [], items: [], cats: [], drivers: [], banners: [], coupons: [], customers: [], reviews: {} };
        let LAST_PENDING_COUNT = 0;

        onAuthStateChanged(auth, (user) => {
            if (user) { document.getElementById('view-auth').style.display = 'none'; initApp(); } 
            else { document.getElementById('view-auth').style.display = 'flex'; }
        });

        window.handleLogin = () => {
            const e = document.getElementById('login-email').value;
            const p = document.getElementById('login-pass').value;
            signInWithEmailAndPassword(auth, e, p).catch(err => document.getElementById('auth-err').innerText = "Wrong Email or Password!");
        };
        window.logout = () => signOut(auth).then(() => location.reload());
        window.toggleSidebar = () => { document.getElementById('sidebar').classList.toggle('open'); document.getElementById('overlay-sidebar').classList.toggle('show'); }

        function playOrderSound() { 
            const a = document.getElementById('order-sound'); 
            if(a){ a.currentTime = 0; a.play().then(() => console.log("Audio Playing")).catch(e => console.log("Interaction Needed", e)); } 
        }

        // --- SCALABLE ARCHITECTURE: SPLIT LISTENERS & QUERY LIMITS ---
        function initApp() {
            const ctx = document.getElementById('sales-chart');
            if(ctx) { new Chart(ctx, { type: 'line', data: { labels: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'], datasets: [{ label: 'Sales (â‚¹)', data: [2000, 5000, 3000, 7000, 4000, 8000, 9500], borderColor: '#FF6D00', tension: 0.3 }] }, options: { responsive: true, maintainAspectRatio: false } }); }

            // 1. Settings Listener
            onValue(ref(db, 'settings'), (snap) => {
                const s = snap.val() || {};
                const isOpen = s.store_open !== false;
                document.getElementById('master-switch').checked = isOpen;
                document.getElementById('store-status-text').innerText = isOpen ? "ONLINE" : "OFFLINE";
                const sw = document.getElementById('store-toggle');
                if(isOpen) { sw.classList.add('online'); sw.classList.remove('offline'); } else { sw.classList.add('offline'); sw.classList.remove('online'); }
                
                document.getElementById('set-del-fee').value = s.delivery_fee || 20;
                document.getElementById('set-free-min').value = s.min_free_delivery || 500;
                document.getElementById('set-cod').checked = s.cod_enabled !== false; 
                document.getElementById('set-online-disc').value = s.online_discount || 0;
            });

            // 2. Menu Listener
            onValue(ref(db, 'menu'), (snap) => {
                DB.items = snap.exists() ? Object.entries(snap.val()).map(([k,v])=>({id:k, ...v})) : [];
                renderMenuUI();
            });

            // 3. Categories Listener
            onValue(ref(db, 'categories'), (snap) => {
                DB.cats = snap.exists() ? Object.entries(snap.val()).map(([k,v])=>({id:k, ...v})) : [];
                renderCatUI();
            });

            // 4. Orders Listener (Real-time, Limit last 100 for Speed)
            // Using query + limitToLast to prevent browser crash with 200k orders
            onValue(query(ref(db, 'orders'), limitToLast(100)), (snap) => {
                DB.orders = snap.exists() ? Object.entries(snap.val()).map(([k,v])=>({id:k, ...v})) : [];
                // Sort descending locally
                DB.orders.sort((a,b) => b.createdAt - a.createdAt);
                
                const pendingOrders = DB.orders.filter(o => o.status === 'placed');
                const newCount = pendingOrders.length;
                if(newCount > LAST_PENDING_COUNT) { playOrderSound(); console.log("New Order!"); }
                LAST_PENDING_COUNT = newCount;
                renderDashboardStats();
                renderOrdersUI();
            });

            // 5. Customers (Limit last 200 for Scale)
            onValue(query(ref(db, 'customers'), limitToLast(200)), (snap) => {
                DB.customers = snap.exists() ? Object.entries(snap.val()).map(([k,v])=>({id:k, ...v})) : [];
                renderCustomersUI();
            });

            onValue(ref(db, 'reviews'), (snap) => {
                DB.reviews = snap.val() || {};
                renderReviewsUI();
            });

            // Others
            onValue(ref(db, 'deliveryPartners'), (snap) => { DB.drivers = snap.exists() ? Object.entries(snap.val()).map(([k,v])=>({id:k, ...v})) : []; renderOthers(); });
            onValue(ref(db, 'sliders'), (snap) => { DB.banners = snap.exists() ? Object.entries(snap.val()).map(([k,v])=>({id:k, ...v})) : []; renderOthers(); });
            onValue(ref(db, 'coupons'), (snap) => { DB.coupons = snap.exists() ? Object.entries(snap.val()).map(([k,v])=>({id:k, ...v})) : []; renderOthers(); });
        }

        // --- SPLIT RENDERING FUNCTIONS FOR PERFORMANCE ---
        function renderDashboardStats() {
            const completed = DB.orders.filter(o => o.status === 'completed');
            const pending = DB.orders.filter(o => ['placed','cooking','driver_assigned'].includes(o.status)).length;
            document.getElementById('d-sales').innerText = 'â‚¹' + completed.reduce((sum, o) => sum + (parseInt(o.total)||0), 0);
            document.getElementById('d-orders').innerText = completed.length;
            document.getElementById('d-pending').innerText = pending;
            document.getElementById('d-items').innerText = DB.items.length;
            const badge = document.getElementById('nav-badge');
            if(pending > 0) { badge.style.display='inline-block'; badge.innerText = pending; } else { badge.style.display='none'; }
        }

        function renderMenuUI() {
            const tItem = document.getElementById('item-list').getElementsByTagName('tbody')[0]; tItem.innerHTML = '';
            DB.items.forEach(i => {
                tItem.innerHTML += `<tr><td><div style="display:flex; gap:10px; align-items:center;"><img src="${i.image}" style="width:34px; height:34px; border-radius:6px; object-fit:cover; border:1px solid #eee;"> <div><div style="font-weight:bold;">${i.name}</div><div style="font-size:0.7rem; color:#888;">${i.category}</div></div></div></td><td>â‚¹${i.price}</td><td style="white-space:nowrap;"><button class="btn b-info b-sm" onclick="viewProd('${i.id}')" style="margin-right:4px;"><i class="fa-solid fa-eye"></i></button><button class="btn b-dark b-sm" onclick="editItem('${i.id}')" style="margin-right:4px;"><i class="fa-solid fa-pen"></i></button><button class="btn b-sm" style="color:var(--danger); background:#ffebee;" onclick="del('menu/${i.id}')"><i class="fa-solid fa-trash"></i></button></td></tr>`;
            });
        }

        function renderCatUI() {
            const cList = document.getElementById('cat-list'); const cSel = document.getElementById('i-cat'); 
            cList.innerHTML = ''; cSel.innerHTML = '';
            DB.cats.forEach(c => {
                cList.innerHTML += `<div style="display:flex; justify-content:space-between; align-items:center; background:#f9f9f9; padding:8px 12px; border-radius:10px; border:1px solid #eee;"><div style="display:flex; align-items:center; gap:10px;"><img src="${c.image}" style="width:36px; height:36px; border-radius:50%; border:2px solid white; object-fit:cover;"><span style="font-weight:700;">${c.name}</span></div><div><i class="fa-solid fa-pen" style="color:var(--brand); cursor:pointer; margin-right:10px;" onclick="editCat('${c.id}')"></i><i class="fa-solid fa-trash" style="color:#ddd; cursor:pointer;" onclick="del('categories/${c.id}')"></i></div></div>`;
                cSel.innerHTML += `<option value="${c.name}">${c.name}</option>`;
            });
        }

        function renderOrdersUI() {
            const tOrd = document.getElementById('order-list').getElementsByTagName('tbody')[0]; tOrd.innerHTML = '';
            DB.orders.forEach(o => {
                let s = o.status, cls = 'bg-new'; if(s=='cooking') cls='bg-cook'; if(s=='out_for_delivery') cls='bg-out'; if(s=='completed') cls='bg-done'; if(s=='cancelled') cls='bg-can';
                let drvDisplay = '<span style="color:#ccc; font-size:0.7rem;">Unassigned</span>';
                if(o.driverName) {
                    const is3rd = o.deliveryProvider && o.deliveryProvider !== 'Internal';
                    drvDisplay = is3rd ? `<div style="font-size:0.75rem; font-weight:bold; color:#7B1FA2;">${o.deliveryProvider||'Ext'}: ${o.driverName.split(' ')[0]}</div>` : `<div style="font-size:0.75rem; font-weight:bold; color:var(--brand);"><i class="fa-solid fa-id-badge"></i> ${o.driverName}</div>`;
                }
                const confirmedBadge = o.userConfirmed ? '<i class="fa-solid fa-check-circle" style="color:#27AE60" title="User Confirmed"></i> ' : '';
                tOrd.innerHTML += `<tr><td><b>#${o.id.slice(-4)}</b></td><td><div style="font-weight:700;">${confirmedBadge}${o.userName}</div><div style="font-size:0.7rem; color:#666;">${o.userPhone}</div></td><td>â‚¹${o.total}</td><td><span class="badge ${cls}">${s.replace('_',' ')}</span><div style="margin-top:2px;">${drvDisplay}</div></td><td><button class="btn b-prim b-sm" onclick="manageOrder('${o.id}')">Action</button></td></tr>`;
            });
        }

        function renderCustomersUI() {
            const tCust = document.getElementById('customer-list-table').getElementsByTagName('tbody')[0]; tCust.innerHTML = '';
            // Since we limit fetch, just render what we have
            DB.customers.forEach(c => {
                tCust.innerHTML += `<tr><td style="font-weight:700;">${c.name}</td><td>${c.phone || '-'}</td><td>${c.email}</td><td style="font-size:0.8rem; max-width:200px;" class="ellipsis">${c.address || '-'}</td><td><span class="badge bg-done">Recent</span></td></tr>`;
            });
        }

        function renderReviewsUI() {
            const tRev = document.getElementById('review-list-table').getElementsByTagName('tbody')[0]; tRev.innerHTML = '';
            let allReviews = [];
            Object.keys(DB.reviews).forEach(prodId => {
                const prod = DB.items.find(x => x.id === prodId) || {name: 'Deleted Item'};
                const rList = DB.reviews[prodId];
                Object.keys(rList).forEach(rId => {
                    allReviews.push({ id: rId, prodId: prodId, prodName: prod.name, ...rList[rId] });
                });
            });
            allReviews.sort((a,b) => b.timestamp - a.timestamp).forEach(r => {
                const stars = Array(5).fill(0).map((_,i) => `<i class="fa-solid fa-star ${i < r.rating ? 'star-gold' : 'star-gray'}"></i>`).join('');
                const platform = r.platform ? `<span class="device-badge">${r.platform}</span>` : '';
                const isReal = !r.isAdminAdded;
                const typeBadge = isReal ? '<span class="badge bg-cook">REAL</span>' : '<span class="badge bg-new">ADMIN</span>';
                tRev.innerHTML += `<tr><td style="font-size:0.85rem; font-weight:700;">${r.prodName}<br>${typeBadge}</td><td>${r.userName} <br><span style="font-size:0.7rem; color:#888;">${platform}</span></td><td>${stars}</td><td style="font-size:0.85rem; color:#555;">${r.comment}</td><td style="font-size:0.75rem;">${new Date(r.timestamp).toLocaleDateString()}</td><td><button class="btn b-dark b-sm" onclick="editReview('${r.prodId}', '${r.id}')"><i class="fa-solid fa-pen"></i></button><button class="btn b-dang b-sm" onclick="del('reviews/${r.prodId}/${r.id}')"><i class="fa-solid fa-trash"></i></button></td></tr>`;
            });
        }

        function renderOthers() {
            const tDry = document.getElementById('driver-list').getElementsByTagName('tbody')[0]; tDry.innerHTML = '';
            DB.drivers.forEach(d => {
                let st = d.blocked ? '<span class="badge bg-can">Blocked</span>' : (d.approved?'<span class="badge bg-done">Active</span>':'<span class="badge bg-new">Wait</span>');
                tDry.innerHTML += `<tr><td>${d.name}</td><td>${d.phone}</td><td>${st}</td><td>${!d.approved ? `<button class="btn b-succ b-sm" onclick="updDriver('${d.id}',{approved:true})">âœ”</button>`:''} ${!d.blocked && d.approved ? `<button class="btn b-dang b-sm" onclick="updDriver('${d.id}',{blocked:true})">ðŸš«</button>`:''} ${d.blocked ? `<button class="btn b-dark b-sm" onclick="updDriver('${d.id}',{blocked:false})">ðŸ”“</button>`:''}</td></tr>`;
            });
            document.getElementById('ban-list').innerHTML = DB.banners.map(b => `<div style="position:relative;"><img src="${b.image}" style="width:100%; height:80px; object-fit:cover; border-radius:8px; border:1px solid #ddd;"><div style="position:absolute; top:4px; right:4px; background:white; border-radius:50%; width:24px; height:24px; text-align:center; color:red; cursor:pointer; font-size:12px; line-height:24px;" onclick="del('sliders/${b.id}')"><i class="fa-solid fa-trash"></i></div></div>`).join('');
            document.getElementById('coup-list').innerHTML = DB.coupons.map(c => {
                const catTxt = c.category ? `<span style="font-size:0.7rem; background:#eee; padding:2px 6px; border-radius:4px; margin-left:5px;">${c.category} only</span>` : '';
                return `<div style="display:flex; justify-content:space-between; align-items:center; background:#F9F9F9; padding:10px; border-radius:8px; margin-bottom:5px; border:1px solid #eee;"><div><b>${c.id}</b> <span style="font-size:0.8rem; color:#666;">${c.type=='flat'?'Flat â‚¹':'% '}${c.value} OFF</span>${catTxt}</div><i class="fa-solid fa-trash" style="color:#ccc; cursor:pointer;" onclick="del('coupons/${c.id}')"></i></div>`;
            }).join('');
        }

        window.openAddItemModal = () => {
            document.getElementById('item-modal-title').innerText = "Add New Dish";
            document.getElementById('i-id').value = ''; 
            ['i-name','i-price','i-desc','i-img','i-img-1','i-img-2','i-img-3','i-unit-val'].forEach(id => document.getElementById(id).value = '');
            document.getElementById('i-stk').value = 50; document.getElementById('i-unit-type').value = '';
            modal('m-item');
        };

        window.openCatModal = () => { document.getElementById('cat-modal-title').innerText = "New Category"; document.getElementById('c-id').value = ''; document.getElementById('c-name').value = ''; document.getElementById('c-img').value = ''; modal('m-cat'); };
        window.editCat = (id) => { const c = DB.cats.find(x => x.id === id); if(!c) return; document.getElementById('cat-modal-title').innerText = "Edit Category"; document.getElementById('c-id').value = id; document.getElementById('c-name').value = c.name; document.getElementById('c-img').value = c.image; modal('m-cat'); };
        window.saveCat = () => { const id = document.getElementById('c-id').value; const n = document.getElementById('c-name').value; const img = document.getElementById('c-img').value; if(id) update(ref(db, 'categories/'+id), { name: n, image: img }).then(()=>shut('m-cat')); else { const newId = n.toLowerCase().replace(/\s/g,'_'); update(ref(db, 'categories/'+newId), { name: n, image: img, active: true }).then(()=>shut('m-cat')); } };

        window.editItem = (id) => {
            const i = DB.items.find(x => x.id === id); if(!i) return;
            document.getElementById('item-modal-title').innerText = "Edit: " + i.name; document.getElementById('i-id').value = i.id;
            document.getElementById('i-name').value = i.name; document.getElementById('i-cat').value = i.category; document.getElementById('i-price').value = i.price;
            document.getElementById('i-desc').value = i.description || ''; document.getElementById('i-stk').value = i.stock;
            document.getElementById('i-unit-type').value = i.unitType || ''; document.getElementById('i-unit-val').value = i.unitVal || '';
            const gallery = i.gallery || [i.image];
            document.getElementById('i-img').value = gallery[0] || ''; document.getElementById('i-img-1').value = gallery[1] || '';
            document.getElementById('i-img-2').value = gallery[2] || ''; document.getElementById('i-img-3').value = gallery[3] || '';
            modal('m-item');
        };

        window.saveItem = () => {
            const id = document.getElementById('i-id').value; const finalId = id || push(ref(db, 'menu')).key;
            const mainImg = document.getElementById('i-img').value;
            const gal = [mainImg, document.getElementById('i-img-1').value, document.getElementById('i-img-2').value, document.getElementById('i-img-3').value].filter(u => u && u.length>5);
            const payload = { name: document.getElementById('i-name').value, category: document.getElementById('i-cat').value, price: parseInt(document.getElementById('i-price').value), description: document.getElementById('i-desc').value, image: mainImg, gallery: gal, stock: parseInt(document.getElementById('i-stk').value), unitType: document.getElementById('i-unit-type').value, unitVal: document.getElementById('i-unit-val').value, active: true };
            update(ref(db, 'menu/'+finalId), payload).then(() => shut('m-item'));
        };

        // MANUAL REVIEW LOGIC (ADD & EDIT)
        window.openReviewModal = () => {
            document.getElementById('rev-modal-title').innerText = "Add Manual Review";
            document.getElementById('ar-id').value = ''; 
            const prodSel = document.getElementById('ar-product');
            prodSel.innerHTML = '';
            DB.items.forEach(i => prodSel.innerHTML += `<option value="${i.id}">${i.name}</option>`);
            document.getElementById('ar-name').value = ''; document.getElementById('ar-rating').value = 5; document.getElementById('ar-comment').value = '';
            prodSel.disabled = false; modal('m-add-review');
        }

        window.editReview = (prodId, revId) => {
            const r = DB.reviews[prodId][revId]; if(!r) return;
            document.getElementById('rev-modal-title').innerText = "Edit Review";
            document.getElementById('ar-id').value = revId; 
            const prodSel = document.getElementById('ar-product');
            prodSel.innerHTML = `<option value="${prodId}" selected>${DB.items.find(x=>x.id==prodId)?.name}</option>`;
            prodSel.disabled = true; 
            document.getElementById('ar-name').value = r.userName; document.getElementById('ar-rating').value = r.rating; document.getElementById('ar-comment').value = r.comment;
            modal('m-add-review');
        }

        window.saveAdminReview = () => {
            const pid = document.getElementById('ar-product').value;
            const name = document.getElementById('ar-name').value;
            const rate = parseInt(document.getElementById('ar-rating').value);
            const comment = document.getElementById('ar-comment').value;
            const existingId = document.getElementById('ar-id').value;
            if(!name || !comment) return alert("Fill all details");
            const finalUid = existingId ? existingId : 'admin_gen_' + Date.now();
            update(ref(db, `reviews/${pid}/${finalUid}`), { userId: finalUid, userName: name, rating: rate, comment: comment, timestamp: serverTimestamp(), isAdminAdded: true }).then(() => { alert("Review Saved!"); shut('m-add-review'); });
        }

        window.sendNotification = async (token, title, body) => {
            if (!FCM_SERVER_KEY) return; 
            fetch('https://fcm.googleapis.com/fcm/send', {
                method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': 'key=' + FCM_SERVER_KEY },
                body: JSON.stringify({ to: token, notification: { title: title, body: body, icon: 'https://cdn-icons-png.flaticon.com/512/732/732200.png', click_action: 'https://your-domain.com/' } })
            }).catch(e => console.error(e));
        }

        window.sendBroadcast = () => {
            const title = document.getElementById('br-title').value; const body = document.getElementById('br-msg').value;
            if(!title || !body) return alert("Please enter Title and Message!");
            alert("Sending to all users...");
            get(ref(db, 'customers')).then(snap => { const users = snap.val(); if(users) Object.values(users).forEach(u => { if(u.fcmToken) sendNotification(u.fcmToken, title, body); }); alert("Broadcast Complete!"); shut('m-broadcast'); });
        };

        window.setMode = (mode, oid) => {
            if(mode === 'internal') { document.getElementById('tab-internal-'+oid).classList.add('active'); document.getElementById('tab-external-'+oid).classList.remove('active'); document.getElementById('view-internal-'+oid).style.display = 'flex'; document.getElementById('view-external-'+oid).style.display = 'none'; } 
            else { document.getElementById('tab-internal-'+oid).classList.remove('active'); document.getElementById('tab-external-'+oid).classList.add('active'); document.getElementById('view-internal-'+oid).style.display = 'none'; document.getElementById('view-external-'+oid).style.display = 'block'; }
        }

        // ENHANCED ORDER MODAL WITH WHATSAPP BILLING
        window.manageOrder = (oid) => {
            const o = DB.orders.find(x => x.id === oid);
            const drvOps = DB.drivers.filter(d => d.approved && !d.blocked).map(d => `<option value="${d.id}">${d.name}</option>`).join('');
            const payInfo = o.paymentMode === 'Online' ? `<span style="color:green; font-weight:bold;">PAID (ID: ${o.paymentId || 'N/A'})</span>` : `<span style="color:orange; font-weight:bold;">COD</span>`;
            
            document.getElementById('k-order-body').innerHTML = `
                <div style="background:#f9f9f9; padding:15px; border-radius:8px; border:1px solid #eee;">
                    <div style="display:flex; justify-content:space-between;"><b>${o.userName}</b> <a href="tel:${o.userPhone}" style="color:var(--brand); text-decoration:none;"><i class="fa-solid fa-phone"></i> Call</a></div>
                    <p style="font-size:0.85rem; color:#555; margin-top:5px;">${o.address}</p>
                    <div style="margin-top:10px; font-size:0.9rem;">Payment: ${payInfo}</div>
                    <div style="border-top:1px dashed #ddd; margin-top:10px; padding-top:5px; font-size:0.9rem;">${o.items.map(i=>`<div>${i.qty} x ${i.name}</div>`).join('')}</div>
                    <div style="font-weight:800; text-align:right; margin-top:5px; font-size:1.1rem;">Total: â‚¹${o.total}</div>
                </div>
                <div style="display:flex; gap:10px; margin-top:15px;">
                    <button class="btn b-wa b-sm" style="flex:1" onclick="shareWhatsApp('${o.id}')"><i class="fa-brands fa-whatsapp"></i> WhatsApp Bill</button>
                    <button class="btn b-dark b-sm" style="flex:1" onclick="printBill('${o.id}')"><i class="fa-solid fa-print"></i> Print</button>
                    <button class="btn b-dang b-sm" onclick="updStatus('${o.id}','cancelled')">Cancel</button>
                </div>
                <h4 style="margin:15px 0 5px;">Change Status</h4>
                <div style="display:flex; gap:5px; flex-wrap:wrap;">
                    <button class="btn b-sm bg-cook" onclick="updStatus('${o.id}','cooking', '${o.userId}')">Cooking</button>
                    <button class="btn b-sm bg-out" onclick="updStatus('${o.id}','out_for_delivery', '${o.userId}')">Out</button>
                    <button class="btn b-sm bg-done" onclick="updStatus('${o.id}','completed', '${o.userId}')">Done</button>
                </div>
                <h4 style="margin:20px 0 5px;">Assign Delivery</h4>
                <div class="driver-tabs">
                    <div id="tab-internal-${o.id}" class="d-tab active" onclick="setMode('internal', '${o.id}')">Internal Staff</div>
                    <div id="tab-external-${o.id}" class="d-tab" onclick="setMode('external', '${o.id}')">Porter / 3rd Party</div>
                </div>
                <div id="view-internal-${o.id}" style="display:flex; gap:10px;">
                    <select id="sel-drv-${o.id}" class="inp" style="margin:0;"><option value="">Select Staff...</option>${drvOps}</select>
                    <button class="btn b-prim b-sm" onclick="assignDriver('${o.id}', '${o.userId}')">Set</button>
                </div>
                <div id="view-external-${o.id}" style="display:none; background:#FDF2E9; padding:15px; border-radius:10px;">
                    <label class="text-sm">Provider Name</label><input type="text" id="ext-prov-${o.id}" class="inp" style="padding:8px;" value="Porter">
                    <div class="inp-grp" style="margin-bottom:10px;">
                        <div><label class="text-sm">Driver Name</label><input type="text" id="ext-name-${o.id}" class="inp" style="padding:8px;" placeholder="Name"></div>
                        <div><label class="text-sm">Driver Phone</label><input type="number" id="ext-phone-${o.id}" class="inp" style="padding:8px;" placeholder="98XXXXXXXX"></div>
                    </div>
                    <label class="text-sm">Tracking Link (Optional)</label><input type="text" id="ext-link-${o.id}" class="inp" style="padding:8px;" placeholder="https://porter.in/track/...">
                    <button class="btn b-prim b-sm" style="width:100%; margin-top:5px;" onclick="assignExternal('${o.id}', '${o.userId}')">Assign 3rd Party</button>
                </div>
            `;
            modal('m-order');
        };

        // --- NEW WHATSAPP BILLING FIX ---
        window.shareWhatsApp = (oid) => {
            const o = DB.orders.find(x => x.id === oid);
            
            // Build Item List String with Prices
            let itemsTxt = o.items.map(i => `â–ª ${i.qty} x ${i.name} = â‚¹${i.price * i.qty}`).join('\n');
            
            // Format Financials
            let discountTxt = o.discount > 0 ? `ðŸŽ‰ Discount: -â‚¹${o.discount}\n` : '';
            let payStatus = o.paymentMode === 'Online' ? 'Online (Paid) âœ…' : 'Cash on Delivery ðŸ’µ';
            
            // Build Full Message
            let text = 
`*Hare Krishna!* ðŸ™

Hello *${o.userName}*, here is your Order Receipt from *Govinda's Prasadam*.

ðŸ“¦ *Order ID:* #${o.id.slice(-4).toUpperCase()}
ðŸ“… *Date:* ${new Date(o.createdAt).toLocaleString()}

ðŸ›’ *YOUR ORDER:*
${itemsTxt}

--------------------------------
ðŸ’µ Subtotal: â‚¹${o.subTotal}
ðŸšš Delivery: â‚¹${o.deliveryFee}
${discountTxt}ðŸ’° *TOTAL:* â‚¹${o.total}
--------------------------------

ðŸ“ *Address:*
${o.address}

ðŸ’³ *Payment:* ${payStatus}

Thank you for serving! Hare Krishna.`;

            // Use encodeURIComponent to ensure special characters don't break the link
            window.open(`https://wa.me/91${o.userPhone}?text=${encodeURIComponent(text)}`, '_blank');
        };

        window.updStatus = (oid, st, uid) => {
            update(ref(db, 'orders/'+oid), { status: st });
            if(st === 'cooking') sendNotification(uid, "Kitchen Update ðŸ‘¨â€ðŸ³", "Your prasadam is being prepared with love!");
            if(st === 'out_for_delivery') sendNotification(uid, "On The Way ðŸ›µ", "Driver has picked up your order.");
            if(st === 'completed') sendNotification(uid, "Delivered âœ…", "Thank you for serving Govinda! Hare Krishna!");
        };

        window.assignDriver = (oid, uid) => {
            const did = document.getElementById('sel-drv-'+oid).value;
            if(!did) return alert("Select Driver");
            const d = DB.drivers.find(x => x.id === did);
            update(ref(db, 'orders/'+oid), { driverId: did, driverName: d.name, driverPhone: d.phone, deliveryProvider: 'Internal', status: 'out_for_delivery' });
            sendNotification(uid, "Driver Assigned", `${d.name} (Staff) is bringing your order!`); shut('m-order');
        }

        window.assignExternal = (oid, uid) => {
            const provider = document.getElementById('ext-prov-'+oid).value || "External";
            const dName = document.getElementById('ext-name-'+oid).value;
            const dPhone = document.getElementById('ext-phone-'+oid).value;
            const dLink = document.getElementById('ext-link-'+oid).value;
            if(!dName) return alert("Please enter Driver Name!");
            update(ref(db, 'orders/'+oid), { driverId: 'EXTERNAL', driverName: dName, driverPhone: dPhone || '', deliveryProvider: provider, trackingUrl: dLink || '', status: 'out_for_delivery' });
            let body = `${provider} driver ${dName} is bringing your order.`; if(dLink) body += " Tap to Track!";
            sendNotification(uid, `On The Way (${provider})`, body); shut('m-order');
        }

        window.printBill = (oid) => {
            const o = DB.orders.find(x => x.id === oid);
            document.getElementById('inv-id').innerText = '#' + o.id.slice(-4).toUpperCase();
            document.getElementById('inv-name').innerText = o.userName;
            document.getElementById('inv-date').innerText = new Date(o.createdAt).toLocaleString();
            const tb = document.getElementById('inv-items'); tb.innerHTML = '';
            o.items.forEach(i => tb.innerHTML += `<tr><td>${i.qty} x ${i.name}</td><td style="text-align:right;">${i.price*i.qty}</td></tr>`);
            document.getElementById('inv-sub').innerText = 'Sub: ' + o.subTotal;
            document.getElementById('inv-del').innerText = 'Del: ' + o.deliveryFee;
            document.getElementById('inv-disc').innerText = 'Dsc: -' + (o.discount||0);
            document.getElementById('inv-total').innerText = 'â‚¹' + o.total;
            window.print();
        }

        window.viewProd = (id) => {
            const i = DB.items.find(x=>x.id===id); if(!i) return;
            let gl = i.gallery || [i.image]; let th = gl.map(url => `<img src="${url}" class="thumb-img" onclick="document.getElementById('p-main').src='${url}'">`).join('');
            document.getElementById('pv-content').innerHTML = `<img src="${gl[0]}" id="p-main" class="prev-main-img"><div class="thumb-row">${th}</div><h2 style="margin-top:10px;">${i.name}</h2><h3 style="color:var(--brand)">â‚¹${i.price}</h3><p style="font-size:0.9rem; color:#555;">${i.description || 'No Details'}</p><div style="margin-top:10px;"><span class="unit-tag">${i.category}</span> ${i.unitType?`<span class="unit-tag" style="background:#f3e5f5; color:#7b1fa2">${i.unitVal}${i.unitType}</span>`:''}</div>`;
            modal('m-prod-view');
        }

        window.nav = (p, el) => {
            document.querySelectorAll('[id^="view-"]').forEach(x=>x.classList.add('hide'));
            document.getElementById('view-'+p).classList.remove('hide');
            document.querySelectorAll('.nav-btn').forEach(b=>b.classList.remove('active'));
            if(el) el.classList.add('active');
            document.getElementById('sidebar').classList.remove('open');
            document.getElementById('overlay-sidebar').classList.remove('show');
            document.getElementById('page-title').innerText = p.toUpperCase();
        };

        window.openCoupModal = () => {
            const catSel = document.getElementById('cp-cat');
            catSel.innerHTML = '<option value="">All Menu (Global)</option>';
            DB.cats.forEach(c => { catSel.innerHTML += `<option value="${c.name}">${c.name}</option>`; });
            modal('m-coup');
        };

        window.saveCoup = () => {
            const code = document.getElementById('cp-code').value.toUpperCase();
            if(!code) return alert("Code Required");
            const cat = document.getElementById('cp-cat').value; 
            set(ref(db, 'coupons/'+code), { value: parseInt(document.getElementById('cp-val').value), type: document.getElementById('cp-type').value, minOrder: parseInt(document.getElementById('cp-min').value), category: cat, active:true }).then(()=>shut('m-coup')); 
        };

        window.toggleStore = (v) => update(ref(db,'settings'), { store_open: v });
        
        // A-Z CONTROL SAVE FUNCTION
        window.saveSettings = () => {
            update(ref(db,'settings'), { 
                delivery_fee: document.getElementById('set-del-fee').value, 
                min_free_delivery: document.getElementById('set-free-min').value,
                cod_enabled: document.getElementById('set-cod').checked,
                online_discount: document.getElementById('set-online-disc').value
            }).then(()=>alert("Settings Saved Successfully!"));
        };

        window.saveBan = () => push(ref(db,'sliders'), {image:document.getElementById('b-img').value}).then(()=>shut('m-ban'));
        window.del = (p) => confirm("Delete permanently?") ? remove(ref(db,p)) : null;
        window.updDriver = (id,d) => update(ref(db,'deliveryPartners/'+id), d);
        window.modal = (id) => document.getElementById(id).style.display='flex';
        window.shut = (id) => document.getElementById(id).style.display='none';
    </script>
</body>
</html>
